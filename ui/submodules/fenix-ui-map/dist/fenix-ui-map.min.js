/* 
 * fenix-ui-map v0.2.1 
 * Copyright 2016  
 * FENIX Development Team 
 * 
 * Licensed under the GPL3 license. 
 * 
 * Source: 
 * https://github.com/FENIX-Platform/fenix-ui-map.git 
 */
var FM,originalFM;if(!window.console)var console={};console.log||(console.log=function(){}),console.warn||(console.warn=function(){}),console.error||(console.error=function(){}),console.info||(console.info=function(){}),typeof exports!=void 0+""?FM=exports:(originalL=window.FM,FM={},FM.noConflict=function(){return window.FM=originalFM,this},window.FM=FM),FM.version="0.0.1",FM.author="Simone Murzilli - simone.murzilli@gmail.com; simone.murzilli@fao.org",FM.Class=function(){},FM.Class.extend=function(a){var b=function(){this.initialize&&this.initialize.apply(this,arguments),this._initHooks&&this.callInitHooks()},c=function(){};c.prototype=this.prototype;var d=new c;d.constructor=b,b.prototype=d;for(var e in this)this.hasOwnProperty(e)&&"prototype"!==e&&(b[e]=this[e]);a.statics&&(FM.extend(b,a.statics),delete a.statics),a.includes&&(FM.Util.extend.apply(null,[d].concat(a.includes)),delete a.includes),a.options&&d.options&&(a.options=FM.extend({},d.options,a.options)),FM.extend(d,a),d._initHooks=[];var f=this;return d.callInitHooks=function(){if(!this._initHooksCalled){f.prototype.callInitHooks&&f.prototype.callInitHooks.call(this),this._initHooksCalled=!0;for(var a=0,b=d._initHooks.length;b>a;a++)d._initHooks[a].call(this)}},b},FM.Class.include=function(a){FM.extend(this.prototype,a)},FM.Class.mergeOptions=function(a){FM.extend(this.prototype.options,a)},FM.Class.addInitHook=function(a){var b=Array.prototype.slice.call(arguments,1),c="function"==typeof a?a:function(){this[a].apply(this,b)};this.prototype._initHooks=this.prototype._initHooks||[],this.prototype._initHooks.push(c)},FM.Util={initializeLangProperties:function(a){var b="";switch(a){case"FR":b="fr";break;case"ES":b="es";break;default:b="en"}var c=FMCONFIG.BASEURL_LANG;$.i18n.properties({name:"I18N",path:c,mode:"both",language:b})},extend:function(a){var b,c,d,e,f=Array.prototype.slice.call(arguments,1);for(c=0,d=f.length;d>c;c++){e=f[c]||{};for(b in e)e.hasOwnProperty(b)&&(a[b]=e[b])}return a},bind:function(a,b){var c=arguments.length>2?Array.prototype.slice.call(arguments,2):null;return function(){return a.apply(b,c||arguments)}},stamp:function(){var a=0,b="_leaflet_id";return function(c){return c[b]=c[b]||++a,c[b]}}(),limitExecByInterval:function(a,b,c){var d,e;return function f(){var g=arguments;return d?void(e=!0):(d=!0,setTimeout(function(){d=!1,e&&(f.apply(c,g),e=!1)},b),void a.apply(c,g))}},falseFn:function(){return!1},formatNum:function(a,b){var c=Math.pow(10,b||5);return Math.round(a*c)/c},splitWords:function(a){return a.replace(/^\s+|\s+$/g,"").split(/\s+/)},setOptions:function(a,b){return a.options=L.extend({},a.options,b),a.options},getParamString:function(a,b){var c=[];for(var d in a)a.hasOwnProperty(d)&&c.push(d+"="+a[d]);return(b&&-1!==b.indexOf("?")?"&":"?")+c.join("&")},template:function(a,b){return a.replace(/\{ *([\w_]+) *\}/g,function(a,c){var d=b[c];if(!b.hasOwnProperty(c))throw new Error("No value provided for variable "+a);return d})},isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)},emptyImageUrl:"data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="},function(){function getPrefixed(a){var b,c,d=["webkit","moz","o","ms"];for(b=0;b<d.length&&!c;b++)c=window[d[b]+a];return c}function timeoutDefer(a){var b=+new Date,c=Math.max(0,16-(b-lastTime));return lastTime=b+c,window.setTimeout(a,c)}var lastTime=0,requestFn=window.requestAnimationFrame||getPrefixed("RequestAnimationFrame")||timeoutDefer,cancelFn=window.cancelAnimationFrame||getPrefixed("CancelAnimationFrame")||getPrefixed("CancelRequestAnimationFrame")||function(a){window.clearTimeout(a)};FM.Util.requestAnimFrame=function(a,b,c,d){return a=L.bind(a,b),c&&requestFn===timeoutDefer?void a():requestFn.call(window,a,d)},FM.Util.cancelAnimFrame=function(a){a&&cancelFn.call(window,a)},FM.Util.replaceAll=function(a,b,c){return a.replace(new RegExp(b,"g"),c)},FM.Util.parseLayerRequest=function(layer){var layerValues=eval(layer),layerRequest="";return $.each(layerValues,function(a,b){layerRequest+="&"+a+"="+b}),layerRequest},FM.Util.randomID=function(){var a=Math.random().toString(36).substring(7);return(a+Date.now()).toLocaleLowerCase()},FM.Util.fire=function(a,b,c){var d=document.createEvent("CustomEvent");d.initCustomEvent(b,!0,!0,c),a.dispatchEvent(d)},FM.Util.on=function(a,b,c,d){a.addEventListener(b,d,!1)}}(),FM.extend=FM.Util.extend,FM.bind=FM.Util.bind,FM.stamp=FM.Util.stamp,FM.setOptions=FM.Util.setOptions,FM.loadModuleLibs=FM.Util.loadModuleLibs,FM.initializeLangProperties=FM.Util.initializeLangProperties,function(a){function b(){this.clear()}function c(a,b){Object.defineProperty&&Object.defineProperty(a,b,{enumerable:!1})}b.prototype={constructor:b,get:function(a){var b=this._data[this.hash(a)];return b&&b[1]},set:function(a,b){this._data[this.hash(a)]=[a,b]},has:function(a){return this.hash(a)in this._data},remove:function(a){delete this._data[this.hash(a)]},type:function(a){var b=Object.prototype.toString.call(a),c=b.slice(8,-1).toLowerCase();return"domwindow"!==c||a?c:a+""},count:function(){var a=0;for(var b in this._data)a++;return a},clear:function(){this._data={}},hash:function(a){switch(this.type(a)){case"undefined":case"null":case"boolean":case"number":case"regexp":return a+"";case"date":return":"+a.getTime();case"string":return'"'+a;case"array":for(var d=[],e=0;e<a.length;e++)d[e]=this.hash(a[e]);return"["+d.join("|");case"object":default:return a._hmuid_||(a._hmuid_=++b.uid,c(a,"_hmuid_")),"{"+a._hmuid_}},forEach:function(a){for(var b in this._data){var c=this._data[b];a(c[1],c[0])}}},b.uid=0,a.HashMap=b}(this.exports||this),FM.UIUtils={loadingPanel:function(a,b){var c="25px";b?document.getElementById(a).innerHTML="<div class='fm-loadingPanel' style='height:"+c+"'></div>":document.getElementById(a).innerHTML="<div class='fm-loadingPanel'></div>"}},FM.WMSUtils=FM.Class.extend({_divID:"",_dropdowndID:"",_outputID:"",_fenixMap:"",_wmsServers:"",_mapID:"",_lang:"EN",WMSCapabilities:function(a,b,c,d,e){this._divID=a,this._dropdowndID=a+"-dropdown",this._outputID=b,this._fenixmap=c,this._wmsServers=d,e&&(this._lang=e),this._createWMSDropDown(this._wmsServers,this._divID,this._dropdowndID,this._outputID,c)},_createWMSDropDown:function(a,b,c,d,e){var f='<select id="'+c+'" style="width:200px;" data-placeholder="'+$.i18n.prop("_selectaWMSServer")+'" class="">';f+='<option value=""></option>';for(var g=0;g<a.length;g++)f+='<option value="'+a[g].url+'">'+a[g].label+"</option>";f+="</select>",$("#"+b).empty(),$("#"+b).append(f);try{$("#"+c).chosen({disable_search_threshold:6,width:"100%"})}catch(h){}var i=this;$("#"+c).change({},function(a){i._createWMSOutputRequest(d,e,$(this).val())})},_createWMSOutputRequest:function(a,b,c){$("#"+a).empty(),FM.UIUtils.loadingPanel(a,"30px");var d=FMCONFIG.BASEURL_MAPS+FMCONFIG.MAP_SERVICE_WMS_GET_CAPABILITIES;d+=d.indexOf("?")>0?"&":"?",d+="SERVICE=WMS",d+="&VERSION=1.1.1",d+="&request=GetCapabilities",d+="&urlWMS="+c;var e=this;$.ajax({type:"GET",url:d,success:function(d){var f=$.parseXML(d);e._createWMSOutput(a,b,f,c)}})},_createWMSOutput:function(a,b,c,d){$("#"+a).empty(),$(c).find("Layer").each(function(){if($(this).children("Name").text()&&""!=$(this).children("Name").text()){var c={};c.layers=$(this).children("Name").text(),c.layername=$(this).children("Name").text(),c.layertitle=$(this).children("Title").text(),c.layertitle=c.layertitle.replace(/_/g," "),c.layertitle=c.layertitle.replace(/3857/g," "),c.styles=$(this).children("Style").children("Name").text(),c.urlWMS=d,c.srs=b.map.options.crs.code,c.openlegend=!0;var e=FM.Util.randomID(),f=FM.Util.replaceAll(FM.guiController.wmsLoaderLayer,"REPLACE",e);$("#"+a).append(f),$("#"+e+"-WMSLayer-title").append(c.layertitle),$("#"+e+"-WMSLayer-title").attr("title",c.layertitle);try{$("#"+e+"-WMSLayer-title").powerTip({placement:"n"})}catch(g){}$("#"+e+"-WMSLayer-box").click({fenixmap:b,layer:c},function(a){a.data.layer.openlegend=!1;var b=new FM.layer(a.data.layer);a.data.fenixmap.addLayer(b);var c="The Layer <b>"+a.data.layer.layertitle+"</b><br> has been added to the map";try{FMPopUp.init({parentID:a.data.fenixmap.id,content:c})}catch(d){}});var h=b,i=$.extend(!0,{},c),j=new FM.layer(i);try{$("#"+e+"-WMSLayer-box").hoverIntent({over:function(){h.addLayer(j)},out:function(){h.removeLayer(j)},timeout:500})}catch(g){}}})},addWMSServer:function(){},_WMSCapabilities:function(a,b,c){var d=FMCONFIG.BASEURL_MAPS+FMCONFIG.MAP_SERVICE_WMS_GET_CAPABILITIES;d+=d.indexOf("?")>0?"&":"?",d+="SERVICE=WMS",d+="&VERSION=1.1.1",d+="&request=GetCapabilities",d+="&urlWMS="+c;var e=this;$.ajax({type:"GET",url:d,success:function(d){var f=$.parseXML(d);e._createWMSDropwDown(a,b,f,c)}})},_createWMSDropwDown:function(a,b,c,d){FM.Util.randomID();$(c).find("Layer").each(function(){var c=FM.Util.randomID();if($(this).children("Name").text()){var e={};e.layers=$(this).children("Name").text(),e.layername=$(this).children("Name").text(),e.layertitle=$(this).children("Title").text(),e.styles=$(this).children("Style").children("Name").text(),e.urlWMS=d,e.openlegend=!0,$("#"+a).append("<div id='WMSLayer-"+c+"'>ddd"+e.layertitle+" + "+e.styles+" <div>"),e.srs=b.map.options.crs.code,$("#WMSLayer-"+c).click({fenixmap:b,layer:e},function(a){var b=new FM.layer(a.data.layer);a.data.fenixmap.addLayerWMS(b)})}})},WFSCapabilities:function(a,b,c){var d=FMCONFIG.BASEURL_MAPS+FMCONFIG.MAP_SERVICE_WMS_GET_CAPABILITIES;d+=d.indexOf("?")>0?"&":"?",d+="SERVICE=WFS",d+="&VERSION=1.0.0",d+="&request=GetCapabilities",d+="&urlWMS="+c;$.ajax({type:"GET",url:d,success:function(d){var e=$.parseXML(d);FM.WMSUtils._createWMSDropwDown(a,b,e,c)}})},_createWFSDropwDown:function(a,b,c,d){$(c).find("Layer").each(function(){var c=FM.Util.randomID();if($(this).children("Name").text()){$("#"+a).append("<div id='WMSLayer-"+c+"'>"+$(this).children("Title").text()+" + "+$(this).children("Style").children("Name").text()+" <div>");var e={};e.layers=$(this).children("Name").text(),e.layername=$(this).children("Name").text(),e.layertitle=$(this).children("Title").text(),e.style=$(this).children("Style").children("Name").text(),e.urlWMS=d,e.openlegend=!0,e.srs=b.map.options.crs.code,$("#WMSLayer-"+c).click({fenixmap:b,layer:e},function(a){var b=new FM.layer(a.data.layer);a.data.fenixmap.addLayerWMS(b)})}})}}),function(){var a={supportsFullScreen:!1,isFullScreen:function(){return!1},requestFullScreen:function(){},cancelFullScreen:function(){},fullScreenEventName:"",prefix:""},b="webkit moz o ms khtml".split(" ");if("undefined"!=typeof document.exitFullscreen)a.supportsFullScreen=!0;else for(var c=0,d=b.length;d>c;c++)if(a.prefix=b[c],"undefined"!=typeof document[a.prefix+"CancelFullScreen"]){a.supportsFullScreen=!0;break}a.supportsFullScreen&&(a.fullScreenEventName=a.prefix+"fullscreenchange",a.isFullScreen=function(){switch(this.prefix){case"":return document.fullScreen;case"webkit":return document.webkitIsFullScreen;default:return document[this.prefix+"FullScreen"]}},a.requestFullScreen=function(a){return""===this.prefix?a.requestFullscreen():a[this.prefix+"RequestFullScreen"]()},a.cancelFullScreen=function(a){return""===this.prefix?document.exitFullscreen():document[this.prefix+"CancelFullScreen"]()}),"undefined"!=typeof jQuery&&(jQuery.fn.requestFullScreen=function(){return this.each(function(){var b=jQuery(this);a.supportsFullScreen&&a.requestFullScreen(b)})}),window.fullScreenApi=a}(),FM.DEPENDENCIES={FENIX_REPOSITORY:"fenixapps.fao.org/repository",fenixmap:{js:["js/FENIXMap.js","js/core/Class.js","js/core/Util.js","js/core/hashmap.js","js/map/config/CONFIG.js","js/map/config/DEPENDENCIES.js","js/map/Map.js","js/map/controller/MapController.js","js/map/layer/Layer.js","js/map/layer/TileLayer.js","js/map/constants/TILELAYER.js","js/map/gui/gui-controller.js","js/map/gui/gui-map.js","js/core/fullscreen.js","js/core/UIUtils.js"],css:["http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css","http://fenixapps.fao.org/repository/js/jquery.power.tip/1.2.0/css/jquery.powertip.css","http://hqlprfenixapp2.hq.un.fao.org:13000/repository/js/jquery.pageslide/2.0/jquery.pageslide.min.css","css/fenix-map.css"]},geocoder:{js:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.geocoder/1.0/Control.OSMGeocoder.js"],css:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.geocoder/1.0/Control.OSMGeocoder.css"]},geosearch:{js:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.geosearch/1.0/l.control.geosearch.js","http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.geosearch/1.0/l.geosearch.provider.openstreetmap.js"],css:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.geosearch/1.0/l.geosearch.css"]},mouseposition:{js:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.mouseposition/1.0/L.Control.MousePosition.js"],css:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.mouseposition/1.0/L.Control.MousePosition.css"]},drawcontrol:{js:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.draw/1.0/leaflet.draw.js"],css:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.draw/1.0/leaflet.draw.css"]},exportplugin:{js:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.export/1.0/export.js"],css:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.export/1.0/export.css"]},controlloading:{js:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.control.loading/1.0/Control.Loading.js"],css:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.control.loading/1.0/Control.Loading.css"]}},FMDEFAULTLAYER={getLayer:function(a,b,c){switch(a.toUpperCase()){case"GAUL0":return FMDEFAULTLAYER._getGAUL("gaul0_faostat_3857_2","adm0_code","the_geom",b,"faost_n",c,"GAUL");case"GAUL0_FAOSTAT":return FMDEFAULTLAYER._getGAUL("gaul0_faostat_3857","faost_code","the_geom",b,"faost_n",c,"FAOSTAT");case"GAUL0_ISO2":return FMDEFAULTLAYER._getGAUL("gaul0_faostat_3857_2","iso2_code","the_geom",b,"faost_n",c,"ISO2");case"GAUL0_ISO3":return FMDEFAULTLAYER._getGAUL("gaul0_faostat_3857_2","iso3_code","the_geom",b,"faost_n",c,"ISO3");case"GAUL0_BOUNDARIES":return FMDEFAULTLAYER._getWMSLayer("gaul0_line_3857");case"GAUL1":return FMDEFAULTLAYER._getGAUL("gaul1_3857","adm1_code","the_geom",b,"adm1_name",c,null);case"GAUL2":return FMDEFAULTLAYER._getGAUL("gaul2_3857","adm2_code","the_geom",b,"adm2_name",c,null)}},_getGAUL:function(a,b,c,d,e,f,g){var h={};return h.layers=a,h.styles="",h.joincolumn=b?b:null,h.joincolumnlabel=e?e:null,h.measurementunit=f?f:null,h.srs="EPSG:3857",h.geometrycolumn=c?c:"",d&&(FMDEFAULTLAYER.joinDefaultPopUp(h),h.joinboundary=g),h},_getWMSLayer:function(a,b,c,d){var e={};return e.layers=a,e.styles=c?c:"",e.srs=d?d:"EPSG:3857",e.urlWMS=b?b:FMCONFIG.DEFAULT_WMS_SERVER,e},joinDefaultPopUp:function(a){var b=a.measurementunit?" "+a.measurementunit:"",c=a.joincolumnlabel?"<div class='fm-popup-join-title'>{{"+a.joincolumnlabel+"}}</div>":"";a.customgfi={content:{en:"<div class='fm-popup'>"+c+"<div class='fm-popup-join-content'>{{{"+a.joincolumn+"}}} <i>"+b+"</i></div></div>",fr:"<div class='fm-popup'>"+c+"{{{"+a.joincolumn+"}}} <i>"+b+"</i></div>",es:"<div class='fm-popup'>"+c+"{{{"+a.joincolumn+"}}} <i>"+b+"</i></div>"},showpopup:!0,output:{show:!0,id:"gfiid"},callback:function(a,b){$("#"+b.outputid).empty(),$("#"+b.outputid).append(a)}}}},FM.TILELAYER={OSM:{url:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",title_en:"OSM - OpenStreetMap"},OSM_GRAYSCALE:{url:"http://{s}.www.toolserver.org/tiles/bw-mapnik/{z}/{x}/{y}.png",title_en:"OSM - OpenStreetMap grayscale"},MAPQUEST:{url:"http://otile1.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png",title_en:"MapQuest"},MAPQUEST_NASA_AERIAL:{url:"http://tile21.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.png",title_en:"MapQuest Aerial"},ESRI_WORLDSTREETMAP:{url:"http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}.png",title_en:"ESRI - World Street Map"},ESRI_WORLDTERRAINBASE:{url:"http://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}",title_en:"ESRI - World Terrain Base"},ACETATE_LABELS:{url:"http://a{s}.acetate.geoiq.com/tiles/acetate-labels/{z}/{x}/{y}.png",title_en:"Acetate Labels"},ACETATE_TERRAIN:{url:"http://a{s}.acetate.geoiq.com/tiles/terrain/{z}/{x}/{y}.png",title_en:"Acetate Terrain"},STAMEN_TONER_BACKGROUND:{url:"http://{s}.tile.stamen.com/toner-background/{z}/{x}/{y}.png",title_en:"Stamen"},ESRI_HISTORICAL_MERCATOR:{url:"http://tiles2.arcgis.com/tiles/IEuSomXfi6iB7a25/arcgis/rest/services/World_Globe_1812/MapServer/{z}/{x}/{y}.png",title_en:"ESRI_HISTORICAL_MERCATOR"}},FM.WMSSERVERS={DEFAULT_EXTERNAL_WMS_SERVERS:[{label:"FENIX Crops Area",label_EN:"FENIX",url:"http://fenix.fao.org/demo/fenix/geoserver/earthstat/wms"},{label:"Greenhouse gases Data",label_EN:"FENIX",url:"http://fenix.fao.org/demo/ghg/geoserver/wms"},{label:"DATA.FAO.ORG",label_EN:"data.fao.org WMS Server",url:"http://data.fao.org/maps/wms"},{label:"UNREDD Congo",label_EN:"UNREDD Congo",url:"http://rdc-snsf.org/diss_geoserver/gwc/service/wms"},{label:"Wales OpenData",label_EN:"Wales OpenData",url:"http://inspire.wales.gov.uk/maps/ows"},{label:"Scotland OpenData",label_EN:"Scotland OpenData",url:"http://sedsh127.sedsh.gov.uk/arcgis/services/ScotGov/StatisticalUnits/MapServer/WMSServer"},{label:"Netherlands OpenData",label_EN:"Netherlands OpenData",url:"http://geodata.nationaalgeoregister.nl/ahn2/wcs"},{label:"German OpenData",label_EN:"German OpenData",url:"http://geo.sv.rostock.de/geodienste/verwaltung/wms"},{label:"ENVIRONMENT OpenData",label_EN:"Scotland OpenData",url:"http://lasigpublic.nerc-lancaster.ac.uk/ArcGIS/services/Biodiversity/GMFarmEvaluation/MapServer/WMSServer"},{label:"OpenGeo Demo Server",label_EN:"OpenGeo Demo Server",url:"http://demo.opengeo.org/geoserver/ows"},{label:"Alberts Map Service",url:"http://maps.gov.bc.ca/arcserver/services/Province/albers_cache/MapServer/WMSServer",urlParameters:"service=WMS"},{label:"Cubert Map Service",label_EN:"Cubert",url:"http://portal.cubewerx.com/cubewerx/cubeserv/cubeserv.cgi"},{label:"GP Map Service",label_EN:"gp map service201",url:"http://geoportal.logcluster.org:8081/gp_map_service201/wms"},{label:"Vienna OpenData",label_EN:"Vienna OpenData",url:"http://data.wien.gv.at/daten/wms"},{label:"Vienna OpenData",label_EN:"Vienna OpenData",url:"http://data.wien.gv.at/daten/wms"}]},FM.Map=FM.Class.extend({id:"",suffix:"",mapContainerID:"",tilePaneID:"",map:"",controller:"",plugins:{},options:{url:{},lang:"EN",guiController:{overlay:!0,baselayer:!0,wmsLoader:!0,enablegfi:!0,layersthumbs:!1},plugins:{fullscreen:!0,zoomcontrol:!0,scalecontrol:!0,legendcontrol:!0,disclaimerfao:!0},baselayers:null,addDefaultBaselayers:!1},mapOptions:{zoomControl:!1,attributionControl:!1,center:[0,0],lat:0,lng:0,zoom:1},initialize:function(a,b,c){this.options=$.extend(!0,{},this.options,b),this.mapOptions=$.extend(!0,{},this.mapOptions,c),FMCONFIG&&(this.options.url=$.extend(!0,{},FMCONFIG,b.url)),FM.initializeLangProperties(this.options.lang);var d=FM.Util.randomID(),e=d+"-container-map",f=d+"-map",g="<div class='fm-map-box fm-box' id='"+e+"'><div>";$(a).length>0?$(a).append(g):$("#"+a).append(g),this.id=f,this.$map=$("#"+e),this.$map.append("<div style='width:100%; height: 100%;' id='"+f+"'><div>"),this.map=new L.Map(this.id,this.mapOptions),this.mapContainerID=e,this.suffix=d,this.setTilePaneID(),this.controller=new FM.mapController(d,this,this.map,this.options.guiController),this.controller.initializeGUI(),this.map._fenixMap=this,this.options.guiController.enablegfi&&this.map.on("click",this.getFeatureInfo,this);(function(){var a=new L.Control;return a.onAdd=function(a){return $("<div  class='fm-swipe' id='"+d+"-swipe'><div style='display:none' class='fm-swipe-handle'id='"+d+"-handle'>&nbsp</div></div>")[0]},a})().addTo(this.map);this.$map.append(FM.Util.replaceAll(FM.guiController.popUpJoinPoint,"REPLACE",d))},createMap:function(a,b,c){this.mapOptions.lat=a||this.mapOptions.lat,this.mapOptions.lng=b||this.mapOptions.lng,this.mapOptions.zoom=c||this.mapOptions.zoom,this.map.setView(new L.LatLng(this.mapOptions.lat,this.mapOptions.lng),this.mapOptions.zoom),this.initializePlugins(),null===this.options.baselayers&&this.options.addDefaultBaselayers===!0&&(this.options.baselayers={OSM:FM.TILELAYER.OSM,OSM_GRAYSCALE:FM.TILELAYER.OSM_GRAYSCALE,ESRI_WORLDSTREETMAP:FM.TILELAYER.ESRI_WORLDSTREETMAP,ESRI_WORLDTERRAINBASE:FM.TILELAYER.ESRI_WORLDTERRAINBASE});for(var d in this.options.baselayers){var e=this.options.baselayers[d],f=new FM.layer({layername:d,layertype:"TILE",layertitle:e["title_"+this.options.lang.toLowerCase()],lang:this.options.lang.toUpperCase()}),g=e.url;delete e.url,f.leafletLayer=new L.TileLayer(g,e),this.addTileLayer(f,!0)}return this},setTilePaneID:function(){this.tilePaneID=this.suffix+"-leaflet-tile-pane";var a=document.getElementById(this.id).childNodes,b=a[1].childNodes;$(b[0]).attr("id",this.tilePaneID)},addTileLayer:function(a,b){b?this.controller.addBaseLayer(a):(this.controller.layerAdded(a),this.map.addLayer(a.leafletLayer)),this.controller.setZIndex(a)},addLayer:function(a){if(a._fenixmap=this,a.layer.layertype)switch(a.layer.layertype){case"JOIN":"SHADED"==a.layer.jointype.toLocaleUpperCase()?this.addShadedLayer(a):"POINT"==a.layer.jointype.toLocaleUpperCase()&&this.addPointLayer(a);break;case"WMS":this.addLayerWMS(a);break;default:this.addLayerWMS(a)}else this.addLayerWMS(a);return this},removeLayer:function(a){return this.controller.removeLayer(a),this},addLayerWMS:function(a){return this.controller.layerAdded(a),this.map.addLayer(a.createLayerWMS()),this.controller.setZIndex(a),this._openlegend(a,!1),this.controller.showHide(a.id,!1),this},addShadedLayer:function(a){a.layerAdded||this.controller.layerAdded(a),this.createShadeLayerRequest(a,a.isadded)},createShadeLayerRequest:function(a,b){b||($("#"+a.id+"-controller-item-getlegend").css("display","inline-block"),$("#"+a.id+"-controller-item-opacity").css("display","block"));var c=this,d=this.options.url.MAP_SERVICE_SHADED;$.ajax({type:"POST",url:d,data:JSON.stringify(a.layer),contentType:"application/json; charset=utf-8",dataType:"json",success:function(d){c._createShadeLayer(a,d,b)}})},_createShadeLayer:function(a,b,c){"string"==typeof b&&(b=$.parseJSON(b)),a.layer.sldurl=b.url,a.layer.urlWMS=this.options.url.DEFAULT_WMS_SERVER,b.geoserverwms&&(a.layer.urlWMS=b.geoserverwms),a.layer.legendHTML=b.legendHTML,a.createLayerWMSSLD(),this._loadLayer(a,c)},_loadLayer:function(a,b){var b=null!=b&&b?!0:!1;b?a.leafletLayer.redraw():(this.map.addLayer(a.leafletLayer),this.controller.setZIndex(a),a.isadded=!0),this._openlegend(a,b),this.controller.showHide(a.id,b)},reAddLayer:function(a){this.map.addLayer(a.leafletLayer),this.controller.setZIndex(a)},_openlegend:function(a,b){try{a.layer.openlegend&&FM.LayerLegend.getLegend(a,a.id+"-controller-item-getlegend",b)}catch(c){console.war("_openlegend error:"+c)}},addPointLayer:function(a){this.controller.layerAdded(a),this.createPointLayerRequest(a)},createPointLayerRequest:function(a){$("#"+a.id+"-controller-item-getlegend").css("display","none"),$("#"+a.id+"-controller-item-getlegend-holder").slideUp("slow"),$("#"+a.id+"-controller-item-opacity").css("display","none");var b=this,c=this.options.url.MAP_SERVICE_SHADED,d=new RequestHandler;d.open("POST",c),d.setContentType("application/x-www-form-urlencoded"),d.request.onload=function(){b._createPointLayer(a,this.responseText)},d.send(FM.Util.parseLayerRequest(a.layer)),d.request.onerror=function(){if(a.layer.pointsLayers)for(var b=0;b<a.layer.pointsLayers.length;b++)this.map.removeLayer(a.layer.pointsLayers[b])}},_createPointLayer:function(a,b){"string"==typeof b&&(b=$.parseJSON(b)),a.layer.sldurl=b.sldurl,a.layer.urlWMS=b.geoserverwms,a.layer.legendHTML=b.legendHTML,a.layer.pointsJSON=b.pointsJSON,this._refreshPointLayer(a)},_refreshPointLayer:function(a){if(a.layer.pointsLayers)for(var b=0;b<a.layer.pointsLayers.length;b++)this.map.removeLayer(a.layer.pointsLayers[b]);"string"==typeof a.layer.pointsJSON&&(a.layer.pointsJSON=$.parseJSON(a.layer.pointsJSON));var c=this;a.layer.pointsLayers=[];for(var b=0;b<a.layer.pointsJSON.length;b++){var d=new L.LatLng(a.layer.pointsJSON[b].lat,a.layer.pointsJSON[b].lon),e=a.layer.pointsJSON[b].properties;a.layer.pointsJSON[b].properties.measurementunit="",null!=a.layer.measurementuni&&(a.layer.pointsJSON[b].properties.measurementunit=a.layer.measurementunit),null!=a.layer.pointColor&&(e.color=a.layer.pointColor),null!=a.layer.pointFillColor&&(e.fillColor=a.layer.pointFillColor),null!=a.layer.pointFillOpacity&&(e.fillOpacity=a.layer.pointFillOpacity);var f=new L.CircleMarker(d,e).addTo(this.map);f.setRadius(a.layer.pointsJSON[b].radius),f.bindPopup(e.title+" - "+e.value),f.on("mouseover",function(){$("#"+c.suffix+"-popup-join-point-holder").show(),$("#"+c.suffix+"-popup-join-point-text").empty(),$("#"+c.suffix+"-popup-join-point-value").empty(),$("#"+c.suffix+"-popup-join-point-text").append(this.options.title),$("#"+c.suffix+"-popup-join-point-value").append(this.options.value+"  <i>"+a.layer.measurementunit+"</i>")}),f.on("mouseout",function(){$("#"+c.suffix+"-popup-join-point-holder").hide()}),a.layer.pointsLayers.push(f)}},syncOnMove:function(a){FM.MapUtils.syncMapsOnMove(this.map,a)},getFeatureInfo:function(a,b){var c=this,b=b?b:c.controller.selectedLayer;b&&(null!=b.layer.layertype&&"JOIN"==b.layer.layertype?FM.SpatialQuery.getFeatureInfoJoin(b,a.layerPoint,a.latlng,c):FM.SpatialQuery.getFeatureInfoStandard(b,a.layerPoint,a.latlng,c))},invalidateSize:function(){this.map.invalidateSize()},initializePlugins:function(){if(null!=this.options.plugins){var a=this;$.each(this.options.plugins,function(b,c){var d=b.toLowerCase(),e="_add"+d;FM.Plugins[e]&&(a.plugins[d]=FM.Plugins[e](a,c))})}},cloneMap:function(a){var b=this.exportMap(),c=(JSON.stringify(b.layers,function(a,b){return"function"==typeof b?b+"":b}),new FM.Map(a,b.map.options,b.map.mapOptions));return c.createMap(),c.createMapFromJSON(b),c},createMapFromJSON:function(a){this.loadOverlays(a.layers.overlays)},exportMap:function(){var a={};return a.map=this._getMapOptions(),a.layers=this._getMapLayers(),a},exportMapToJSONFile:function(){var a=this.exportMap(),b=FM.Util.randomID(),c="data:application/octet-stream;filename=mapview-"+b+".fnx,"+encodeURIComponent(JSON.stringify(a)),d=window.open(c,"mapview-"+b+".fnx");d.focus()},_getMapOptions:function(){var a={options:{},mapOptions:{}};return a.options=$.extend(!0,{},this.options),a.mapOptions=$.extend(!0,_getCurrentMapOptions,this.mapOptions),a.plugins=$.extend(!0,{},this.plugins),a},_getMapLayers:function(){var a={};return a.overlays=this.controller.exportOverlays(),a},loadOverlays:function(a){for(var b=0;b<a.length;b++){var c=new FM.layer(a[b]);this.addLayer(c)}},zoomTo:function(a,b,c){FM.MapUtils.zoomTo(this,a,b,c)},zoomToCountry:function(a,b){FM.MapUtils.zoomToCountry(this,a,b)},getSLDfromCSS:function(a,b){FM.MapUtils.getSLDfromCSS(a,b,this.options.url.CSS_TO_SLD)}}),FM.map=function(a,b,c){return new FM.Map(a,b,c)},FM.LayerLegend={getLegend:function(a,b,c){$("#"+b+"-legend-layertitle").empty(),$("#"+b+"-legendtitle").empty(),$("#"+b+"-legendsubtitle").empty(),$("#"+b+"-content").empty(),a.layer.layertitle&&$("#"+b+"-legend-layertitle").append(a.layer.layertitle),a.layer.legendtitle&&$("#"+b+"-legendtitle").append(a.layer.legendtitle),a.layer.legendsubtitle&&$("#"+b+"-legendsubtitle").append(a.layer.legendsubtitle);var d="";if(a.layer.legendHTML)d=a.layer.legendHTML,$("#"+b+"-content").append(d);else{var e=a.layer.urlWMS+"?";e+="&service=WMS&version=1.1.0&REQUEST=GetLegendGraphic&layer="+a.layer.layers+"&Format=image/png",null!=a.layer.style&&""!=a.layer.style&&(e+="&style="+a.layer.style),a.layer.sldurl&&(e+="&sld="+a.layer.sldurl);var f=e;e+="&LEGEND_OPTIONS=forceLabels:on;forceRule:True;dx:0;dy:0;mx:0;my:0;border:false;fontAntiAliasing:true;fontColor:0x47576F;fontSize:10;bgColor:0xF9F7F3",FM.LayerLegend._loadLegend(e,f,b)}c?$("#"+b+"-holder").is(":visible")&&($("#"+b+"-holder").hide(),$("#"+b+"-holder").slideDown(),a.layer.openlegend=!0):$("#"+b+"-holder").is(":visible")?($("#"+b+"-holder").slideUp(),a.layer.openlegend=!1):($("#"+b+"-holder").slideDown(),a.layer.openlegend=!0),$("#"+b+"-remove").click({id:b+"-holder"},function(b){$("#"+b.data.id).slideUp(),a.layer.openlegend=!1})},_loadLegend:function(a,b,c){var d=new Image;d.name=a,d.src=a;var e='<img id="'+c+'-img" src="'+d.src+'" class="decoded">';d.onload=function(){$("#"+c+"-content").append(e),$("#"+c+"-img").css("width",this.width),$("#"+c+"-img").css("height",this.height)},d.onerror=function(){b?FM.LayerLegend._loadLegend(b,null,c):FM.LayerLegend._nolegend(c)}},_nolegend:function(a){var b='<div class="fm-legend-layertitle">'+$.i18n.prop("_nolegendavailable")+"</div>";$("#"+a+"-content").append(b)}},FM.MAPController=FM.Class.extend({id:"",suffix:"",_map:"",_fenixMap:"",_guiController:{overlay:!0,baselayer:!0,layersthumbs:!0},baseLayersMap:"",currentBaseLayer:"",layersMap:"",layersMapZIndexes:"",zIndexBaseLayer:10,zIndex:100,selectedLayer:"",$boxIcons:"",$boxMenu:"",$boxMenuContainer:"",$boxMenuSelected:"",getFeautureInfoLayer:[],initialize:function(a,b,c,d){this._map=c,this._fenixMap=b,this.suffix=a,this.id=a+"-controller",this._guiController=$.extend({},this._guiController,d),this.baseLayersMap=new HashMap,this.layersMap=new HashMap,this.layersMapZIndexes=new HashMap},initializeGUI:function(){var a=this;if(a._guiController){$("#"+a.id);a.$boxMenu=$(FM.Util.replaceAll(FM.guiController.box,"REPLACE",a.suffix)),a.$boxMenuContainer=a.$boxMenu.find("#"+a.suffix+"-controller-box-content"),a.$boxMenuContainer.css({maxHeight:a._map.getSize().y-60+"px"}),a.$boxIcons=$(FM.Util.replaceAll(FM.guiController.boxIcons,"REPLACE",a.suffix));(function(){var b=new L.Control({position:"bottomleft"});return b.onAdd=function(b){var c=$('<div class="leaflet-control-controller">').append(a.$boxIcons).append(a.$boxMenu),d=c[0];return L.Browser.touch?L.DomEvent.on(d,"click",L.DomEvent.stopPropagation):(L.DomEvent.disableClickPropagation(d),L.DomEvent.on(d,"mousewheel",L.DomEvent.stopPropagation)),d},b})().addTo(a._map);if(a._guiController.overlay&&(a.loadIcon("overlay"),a.initializeOverlayDragging()),a._guiController.baselayer&&a.loadIcon("baselayer"),a._guiController.wmsLoader){this.loadIcon("wmsLoader");var b=new FM.WMSUtils,c=this.suffix+"-controller-wmsLoader-dropdown",d=this.suffix+"-controller-wmsLoader-content",e=FM.WMSSERVERS.DEFAULT_EXTERNAL_WMS_SERVERS;b.WMSCapabilities(c,d,this._fenixMap,e)}}},loadIcon:function(a){var b=FM.guiController,c=a+"Box",d=a+"Icon";this.$boxMenuContainer.append(FM.Util.replaceAll(b[c],"REPLACE",this.suffix));var e=$(FM.Util.replaceAll(b[d],"REPLACE",this.suffix));e.attr("title",$.i18n.prop("_"+a)),this.$boxIcons.show().append(e);try{e.powerTip({placement:"ne"})}catch(f){}var g=this,h=$("#"+g.suffix+"-controller-"+a+"-box");$("#"+this.suffix+"-controller-"+a+"Icon").on("click",{$id:h,suffix:this.suffix},function(a){var b=a.data.$id;a.data.suffix;g.$boxMenu.is(":visible")?g.$boxMenuSelected==b?(g.$boxMenu.slideUp(),b.hide(),g.$boxMenuSelected=""):(g.$boxMenuSelected.hide(),b.slideDown(),g.$boxMenuSelected=b):(g.$boxMenuSelected=b,g.$boxMenuSelected.show(),g.$boxMenu.slideDown())}),$("#"+this.suffix+"-controller-"+a+"-remove").on("click",{$id:h,suffix:this.suffix},function(a){var b=a.data.$id,c=a.data.suffix;$("#"+c+"-controller-box").slideUp(),b.hide()})},initializeOverlayDragging:function(){var a=this;$("#"+this.suffix+"-controller-overlay-content").sortable({cursor:"move",opacity:"0.5",stop:function(b,c){for(var d=$(c.item).parent().children(),e=[],f=0,g=d.length-1;g>=0;g--){var h=$(d[g]).data("layer").id,i=($(d[g]).data("layer").layer.layertitle,f+100);e.push($(d[g]).data("layer").id),a.updateZIndex(h,i),f++}}})},layerAdded:function(a){var b=this;if(a.layerAdded=!0,a.layer.zIndex||(a.layer.zIndex=this.zIndex,a.leafletLayer.setZIndex=a.layer.zIndex),this.zIndex=this.zIndex+2,
!a.layer.hideLayerInControllerList){var c=$(FM.Util.replaceAll(FM.guiController.legend,"REPLACE",a.id)),d=c[0];L.Browser.touch?L.DomEvent.on(d,"click",L.DomEvent.stopPropagation):(L.DomEvent.disableClickPropagation(d),L.DomEvent.on(d,"mousewheel",L.DomEvent.stopPropagation)),b._fenixMap.$map.find(".leaflet-control-legend").append(c);var e="#"+this.suffix+"-controller-overlay-content",f="#"+a.id+"-controller-item",g=a.id+"-controller-item",h=FM.Util.replaceAll(FM.guiController.overlay,"REPLACE",a.id);$(e).prepend(h),$("#"+a.id+"-controller-item-box").data("layer",a);$("#"+a.id+"-controller-item-box").index()+1;this._layerGUIOptions(a),this.layersMap.set(a.id,a),this.layersMapZIndexes.set(a.layer.zIndex,a.id),$(f).attr("title",$.i18n.prop("_dragdroplayer"));try{$(f).powerTip({placement:"e"})}catch(i){}var j=this;b._fenixMap.$map.find(f+"-title").append(a.layer.layertitle).attr("title",a.layer.layertitle);try{$(f+"-title").powerTip({placement:"se"})}catch(i){}var k=$(f+"-remove");k.on("click",{l:a},function(a){a.stopPropagation(),confirm($.i18n.prop("_confirmremovelayer"))&&j.removeLayer(a.data.l),a.preventDefault()}),k.attr("title",$.i18n.prop("_removelayer"));try{removeLayer.powerTip({placement:"n"})}catch(i){}var l=$(f+"-enabledisable");l.on("click",{id:a.id},function(a){j.showHide(a.data.id)}),l.attr("title",$.i18n.prop("_enabledisablelayer"));try{l.powerTip({placement:"se"})}catch(i){}var m=1;null!=a.layer.opacity&&(m=a.layer.opacity);try{var n=$(f+"-opacity");n.slider({orientation:"horizontal",range:"min",min:0,max:1,step:.1,value:m,slide:function(b,c){FM.LayerUtils.setLayerOpacity(a,c.value)}}),n.attr("title",$.i18n.prop("_layeropacity"));try{n.powerTip({placement:"se"})}catch(i){}}catch(i){}var o=$(f+"-getfeatureinfo");if(a.layer.enablegfi){o.on("click",{id:a.id},function(a){var b=j.layersMap.get(a.data.id);j.selectedLayer.id==a.data.id?($("#"+j.selectedLayer.id+"-controller-item-getfeatureinfo").removeClass("fm-icon-getfeatureinfo-selected"),j.selectedLayer="",b.layer.defaultgfi=!1):($("#"+j.selectedLayer.id+"-controller-item-getfeatureinfo").removeClass("fm-icon-getfeatureinfo-selected"),$("#"+a.data.id+"-controller-item-getfeatureinfo").addClass("fm-icon-getfeatureinfo-selected"),j.selectedLayer=b,b.layer.defaultgfi=!0)}),o.attr("title",$.i18n.prop("_getfeatureinfo"));try{o.powerTip({placement:"se"})}catch(i){}a.layer.defaultgfi&&(this.selectedLayer=a,$("#"+this.selectedLayer.id+"-controller-item-getfeatureinfo").removeClass("fm-icon-getfeatureinfo-selected"),$("#"+a.id+"-controller-item-getfeatureinfo").addClass("fm-icon-getfeatureinfo-selected"))}else $(f+"-getfeatureinfo").css("display","none");var p=$(f+"-getlegend");(null==a.layer.showlegend||0!=a.layer.showlegend)&&p.on("click",{id:a.id,idToRender:g+"-getlegend"},function(a){var b=j.layersMap.get(a.data.id);FM.LayerLegend.getLegend(b,a.data.idToRender)}),p.attr("title",$.i18n.prop("_showhidelegend"));try{p.powerTip({placement:"se"})}catch(i){}if(p.css("display","inline-block"),a.layer.layertype&&"JOIN"==a.layer.layertype&&(null==a.layer.switchjointype||a.layer.switchjointype)){$(f+"-switchjointype").css("display","inline-block"),$(f+"-switchjointype").on("click",{id:a.id},function(a){j.switchJoinType(a.data.id)}),"point"==a.layer.jointype.toLowerCase()?$(f+"-switchjointype").attr("title",$.i18n.prop("_switchtoshaded")):"shaded"==a.layer.jointype.toLowerCase()&&$(f+"-switchjointype").attr("title",$.i18n.prop("_switchtopoint"));try{$(f+"-switchjointype").powerTip({placement:"se"})}catch(i){}}var q=$(f+"-swipe");q.on("click",{id:a.id},function(a){var b=j.layersMap.get(a.data.id);null!=b.layer.swipeActive&&b.layer.swipeActive?(FM.LayerSwipe.swipeDeactivate(b,j._map),q.removeClass("fm-icon-swipe-selected")):(FM.LayerSwipe.swipeActivate(b,j._fenixMap.suffix+"-handle",j._fenixMap.suffix+"-map",j._map),q.addClass("fm-icon-swipe-selected"))});var r=$(f+"-zoomtolayer");a.layer.zoomToBBOX&&(r.css("display","inline-block"),r.attr("title",$.i18n.prop("_zoomtolayer")),r.on("click",{id:a.id},function(a){var b=j.layersMap.get(a.data.id);FM.LayerUtils.zoomToLayer(j._map,b.layer)})),a.layer.zoomTo&&(r.css("display","inline-block"),r.attr("title",$.i18n.prop("_zoomtolayer")),r.on("click",{id:a.id},function(a){var b=j.layersMap.get(a.data.id);FM.LayerUtils.zoomToLayer(j._map,b.layer)}));var s=$(f+"-showhide-subicons"),t=$(f+"-subicons");s.on("click",function(a){t.slideToggle("fast"),s.hasClass("fm-icon-up")?(s.removeClass("fm-icon-up"),s.addClass("fm-icon-down")):(s.removeClass("fm-icon-down"),s.addClass("fm-icon-up"))}),s.attr("title",$.i18n.prop("_layersubicons"));try{s.powerTip({placement:"n"})}catch(i){}}},_layerGUIOptions:function(a){a.gui;"JOIN"==a.layer.layertype&&null!=a.layer.gui&&null!=a.layer.gui.nojoinlayerswitch&&a.layer.gui.nojoinlayerswitch&&$("#"+a.id+"-controller-item-switchjointype").css("display","none")},addBaseLayer:function(a){var b=this;a.layer.zIndex=this.zIndexBaseLayer,this.zIndexBaseLayer=this.zIndexBaseLayer+2,this.baseLayersMap.set(a.id,a),this.layersMapZIndexes.set(a.layer.zIndex,a.id);var c="#"+this.suffix+"-controller-baselayer-content",d="#"+a.id+"-controller-item",e=FM.Util.replaceAll(FM.guiController.baselayer,"REPLACE",a.id);e=FM.Util.replaceAll(e,"MAPID",this._fenixMap.id),$(c).append(e),$(d+"-title").append(a.layer.layertitle),b._guiController.layersthumbs?$("#"+a.id+"-controller-item-baselayer-image").addClass("fm-icon-baselayer-"+a.layer.layername):$("#"+a.id+"-controller-item-baselayer-image").remove(),$(d+"-enabledisable").on("click",{id:a.id},function(a){b.showHide(a.data.id)});var f=1;null!=a.layer.opacity&&(f=a.layer.opacity);try{$(d+"-opacity").slider({orientation:"horizontal",range:"min",min:0,max:1,step:.1,value:f,slide:function(b,c){FM.LayerUtils.setLayerOpacity(a,c.value)}})}catch(g){}$("#"+a.id+"-controller-box-item").on("click",{id:a.id},function(a){var c=a.data.id,d=b.baseLayersMap.get(c);b.removeBaseLayerByID(b.currentBaseLayer.id);var e=b.baseLayersMap.get(b.currentBaseLayer.id);$("#"+e.id+"-controller-box-item").removeClass("fm-controller-box-item-baselayer-content-selected"),$("#"+e.id+"-controller-item-opacity").hide(),$("#"+d.id+"-controller-box-item").addClass("fm-controller-box-item-baselayer-content-selected"),$("#"+d.id+"-controller-item-opacity").show(),b._map.addLayer(d.leafletLayer),b.currentBaseLayer=d,b.setZIndex(d)}),1==this.baseLayersMap.count()&&($(d+"-radio").attr("checked",!0),this._map.addLayer(a.leafletLayer),this.currentBaseLayer=a,$("#"+a.id+"-controller-box-item").addClass("fm-controller-box-item-baselayer-content-selected"),$("#"+a.id+"-controller-item-opacity").show(),b.setZIndex(a))},removeLayer:function(a){null!=a.layer.jointype&&"point"==a.layer.jointype?this.removeLayerPoint(a):this.removeLayerDefault(a)},removeLayerDefault:function(a){this._map.removeLayer(a.leafletLayer),this.layersMap.remove(a.id),this.layersMapZIndexes.remove(a.layer.zIndex),$("#"+a.id+"-controller-item-box").remove(),$("#"+a.id+"-controller-item-getlegend-holder").remove()},removeLayerPoint:function(a){for(var b=0;b<a.layer.pointsLayers.length;b++)this._map.removeLayer(a.layer.pointsLayers[b]);this.layersMap.remove(a.id),this.layersMapZIndexes.remove(a.layer.zIndex),$("#"+id+"-controller-item-box").remove()},removeBaseLayerByID:function(a){var b=this.baseLayersMap.get(a);this._map.removeLayer(b.leafletLayer)},switchJoinType:function(a){var b=this.layersMap.get(a);try{$.powerTip.destroy($("#"+b.id+"-controller-item-switchjointype"))}catch(c){}"point"==b.layer.jointype.toLowerCase()?($("#"+b.id+"-controller-item-switchjointype").attr("title",$.i18n.prop("_switchtopoint")),this.switchToShaded(a)):"shaded"==b.layer.jointype.toLowerCase()&&($("#"+b.id+"-controller-item-switchjointype").attr("title",$.i18n.prop("_switchtoshaded")),this.switchToPoint(a));try{$("#"+b.id+"-controller-item-switchjointype").powerTip({placement:"se"})}catch(c){}},switchToPointswitchToPoint:function(a){var b=this.layersMap.get(a);b.layer.jointype="point",null!=b.leafletLayer&&this._map.removeLayer(b.leafletLayer),this._fenixMap.createPointLayerRequest(b)},switchToShaded:function(a){var b=this.layersMap.get(a);if(b.layer.jointype="shaded",null!=b.layer.pointsLayers)for(var c=0;c<b.layer.pointsLayers.length;c++)this._map.removeLayer(b.layer.pointsLayers[c]);this._fenixMap.createShadeLayerRequest(b)},showHide:function(a,b){try{var c=this.layersMap.get(a);c&&(c.layer.jointype&&"point"==c.layer.jointype.toLowerCase()?this.showHidePointLayer(a):this.showHideLayer(a,b))}catch(d){}},showHidePointLayer:function(a){for(var b=this.layersMap.get(a),c=0;c<b.layer.pointsLayers.length;c++)if(null==b.layer.visibility||b.layer.visibility){b.layer.visibility=!1,$("#"+a+"-controller-item-enabledisable").removeClass("fm-icon-enable"),$("#"+a+"-controller-item-enabledisable").addClass("fm-icon-disable");for(var c=0;c<b.layer.pointsLayers.length;c++)this._map.removeLayer(b.layer.pointsLayers[c])}else{b.layer.visibility=!0,$("#"+a+"-controller-item-enabledisable").removeClass("fm-icon-disable"),$("#"+a+"-controller-item-enabledisable").addClass("fm-icon-enable");for(var c=0;c<b.layer.pointsLayers.length;c++)this._map.addLayer(b.layer.pointsLayers[c])}},showHideLayer:function(a,b){try{var c=this.layersMap.get(a);null==b||b?null!=b&&b||(console.log("map - showHideLayer",c),null==c.layer.visibility||c.layer.visibility?(c.layer.visibility=!1,$("#"+a+"-controller-item-enabledisable").removeClass("fm-icon-enable"),$("#"+a+"-controller-item-enabledisable").addClass("fm-icon-disable"),this._map.removeLayer(c.leafletLayer)):(c.layer.visibility=!0,$("#"+a+"-controller-item-enabledisable").removeClass("fm-icon-disable"),$("#"+a+"-controller-item-enabledisable").addClass("fm-icon-enable"),this._map.addLayer(c.leafletLayer),this.setZIndex(c))):0==c.layer.visibility&&($("#"+a+"-controller-item-enabledisable").removeClass("fm-icon-enable"),$("#"+a+"-controller-item-enabledisable").addClass("fm-icon-disable"),this._map.removeLayer(c.leafletLayer))}catch(d){}},updateZIndex:function(a,b){var c=this.layersMap.get(a);c.layer.zIndex=b,c.leafletLayer.setZIndex(b);try{document.getElementById(c.id).style.zIndex=b}catch(d){}},setZIndex:function(a){try{for(var b=document.getElementById(this._fenixMap.tilePaneID).childNodes,c=0,d=b.length;d>c;c++)if(b[c]!==this._container){var e=parseInt(b[c].style.zIndex,10);isNaN(e)&&(b[c].style.zIndex=a.layer.zIndex,b[c].id=a.id,a.leafletLayer.setZIndex(a.layer.zIndex))}}catch(f){}},selectGetFeatureInfoIcon:function(a){for(var b=0;b<this.layersMap.count();b++)this.layersMap._data[b]==a?$("#"+a+"-controller-item-getfeatureinfo").addClass("fm-icon-getfeatureinfo-selected"):$("#"+a+"-controller-item-getfeatureinfo").removeClass("fm-icon-getfeatureinfo-selected")},exportOverlays:function(){var a=[];this.layersMap.forEach(function(b){a.push(b.layer.zIndex)}),a=a.sort();for(var b=[],c=0;c<a.length;c++){var d=!1;d||this.layersMap.forEach(function(e){e.layer.zIndex==a[c]&&(b.push(e.layer),d=!0)})}var e=$.map(b,function(a){return $.extend(!0,{},a)});return e},exportBaselayers:function(){return null}}),FM.mapController=function(a,b,c,d){return new FM.MAPController(a,b,c,d)},FM.guiController={boxIcons:'<div id="REPLACE-controller-box-icons-container" class="fm-icon-box-background fm-controller-box-icons-container"></div>',box:'<div class="fm-box-zindex fm-icon-box-background fm-controller-box-icons-container fm-controller-box" style="display:none" id="REPLACE-controller-box"><div id="REPLACE-controller-box-content"></div></div>',baselayerIcon:'<div class="fm-box-zindex"><div class="fm-icon-sprite fm-baselayers" id="REPLACE-controller-baselayerIcon"><div></div>',baselayerBox:'<div class="fm-box-zindex" id="REPLACE-controller-baselayer-box" style="display:none"><div id="REPLACE-controller-baselayer-title" class="fm-controller-box-title">Baselayers</div><div id="REPLACE-controller-baselayer-remove" class="fm-icon-close-panel-sprite fm-icon-close fm-icon-right"></div><div class="fm-standard-hr"></div><div id="REPLACE-controller-baselayer-content" class="fm-controller-box-content"></div></div>',baselayer:'<div id="REPLACE-controller-box-item" class="fm-box-zindex fm-controller-box-item-baselayer-content"><div id="REPLACE-controller-item"><div class="fm-controller-box-item-baselayer-image" id="REPLACE-controller-item-baselayer-image"></div><div class="fm-controller-box-item-baselayer-text"><div><label class="fm-controller-box-item-baselayer-text fm-controller-item-title" id="REPLACE-controller-item-title"><input id="REPLACE-controller-item-radio"  class="fm-checkbox-hide" type="radio" name="MAPID" value="REPLACE"><label></div><div style="clear:both"></div><div class="fm-opacity-slider-baselayers" id="REPLACE-controller-item-opacity" style="display:none"></div></div></div></div>',overlayIcon:"<div class='fm-box-zindex'><div class='fm-icon-sprite fm-overlays' id='REPLACE-controller-overlayIcon'></div></div>",overlayBox:'<div class="fm-box-zindex" id="REPLACE-controller-overlay-box" style="display:none;"><div id="REPLACE-controller-overlay-title" class="fm-controller-box-title">Selected Layers</div><div id="REPLACE-controller-overlay-remove" class="fm-icon-close-panel-sprite fm-icon-close fm-icon-right"></div><div class="fm-standard-hr"></div><div id="REPLACE-controller-overlay-content" class="fm-controller-box-content"></div></div>',overlay:'<div id="REPLACE-controller-item-box" class="fm-box-zindex fm-controller-box-item"><div id="REPLACE-controller-item" class="fm-controller-box-header"><div class="fm-controller-box-header-text"><div class="fm-controller-item-title" id="REPLACE-controller-item-title" ></div><div class="fm-icon-right fm-icon-layer-panel-sprite fm-icon-down" id="REPLACE-controller-item-showhide-subicons"></div><div class="fm-icon-right fm-icon-layer-panel-sprite fm-icon-panel-remove" id="REPLACE-controller-item-remove"></div><div class="fm-icon-right fm-icon-layer-panel-sprite fm-icon-panel-info" id="REPLACE-controller-item-icon" ></div></div><div style="clear:both"></div><div class="fm-controller-box-icons"><div class="fm-icon-enable" id="REPLACE-controller-item-enabledisable"></div><div  class="fm-opacity-slider" style="margin-right:10px;" id="REPLACE-controller-item-opacity"></div></div><div style="clear:both"></div><div class="fm-controller-box-subicons" id="REPLACE-controller-item-subicons" style="display:none;"><div class="fm-icon-layer-subicons-sprite fm-icon-getlegend" id="REPLACE-controller-item-getlegend"></div><div class="fm-icon-layer-subicons-sprite fm-icon-getfeatureinfo" id="REPLACE-controller-item-getfeatureinfo"></div><div class="fm-icon-layer-subicons-sprite fm-icon-switchJoinType" id="REPLACE-controller-item-switchjointype" style="display:none"></div><div class="fm-icon-layer-subicons-sprite fm-icon-zoomto" id="REPLACE-controller-item-zoomtolayer" style="display:none"></div><div class="fm-icon-layer-subicons-sprite fm-icon-swipe" id="REPLACE-controller-item-swipe"></div><div class="fm-icon-layer-subicons-sprite fm-icon-switchJoinType" id="REPLACE-controller-item-joinsettings" style="display:none"></div></div></div></div></div></div>',wmsLoaderIcon:"<div class='fm-box-zindex'><div class='fm-icon-sprite fm-wmsloader' id='REPLACE-controller-wmsLoaderIcon'></div></div>",wmsLoaderBox:'<div class="fm-box-zindex" id="REPLACE-controller-wmsLoader-box" style="display:none; min-height:300px;"><div id="REPLACE-controller-wmsLoader-title" class="fm-controller-box-title">WMS Loader</div><div id="REPLACE-controller-wmsLoader-remove" class="fm-icon-close-panel-sprite fm-icon-close fm-icon-right"></div><div class="fm-standard-hr"></div><div class="clear:both"></div><div class="fm-WMSLoaderDropDown" id="REPLACE-controller-wmsLoader-dropdown"></div><div id="REPLACE-controller-wmsLoader-content" class="fm-controller-wmsLoader-content"></div></div>',wmsLoaderLayer:'<div id="REPLACE-WMSLayer-box" class="fm-WMSLayer-box"><div id="REPLACE-WMSLayer-icon" class="fm-controller-box-icon fm-icon-info"></div><div id="REPLACE-WMSLayer-title" class="fm-WMSLayer-title"></div></div>',legend:'<div class="fm-icon-box-background fm-box-legend" id="REPLACE-controller-item-getlegend-holder"><div class="fm-legend-title-content"><div id="REPLACE-controller-item-getlegend-legend-layertitle" class="fm-legend-layertitle"></div><div id="REPLACE-controller-item-getlegend-remove" class="fm-icon-close-panel-sprite fm-icon-close fm-icon-right"></div></div><div class="fm-standard-hr"></div><div id="REPLACE-controller-item-getlegend-legendtitle" class="fm-legendtitle"></div><div id="REPLACE-controller-item-getlegend-legendsubtitle" class="fm-legendsubtitle"></div><div id="REPLACE-controller-item-getlegend-content" ></div></div>',popUpJoinPoint:'<div class="fm-box fm-popup-join-point-holder" id="REPLACE-popup-join-point-holder" style="display:none"><div class="fm-popup-join-point-text" id="REPLACE-popup-join-point-text"></div><div class="fm-popup-join-point-value" id="REPLACE-popup-join-point-value"></div></div>'},FM.guiMap={disclaimerfao_en:'<div class="fm-disclaimerfao">The designations employed and the presentation of material in the maps  <br>do not imply the expression of any opinion whatsoever on the part of  <br>FAO concerning the legal or constitutional status of any country, <br>territory or sea area, or concerning the delimitation of frontiers.  <br>South Sudan declared its independence on July 9, 2011. <br>Due to data availability, the assessment presented in the map for Sudan  <br>and South Sudan reflects thesituation up to 2011 for the former Sudan.</div>',disclaimerfao_es:"",disclaimerfao_es_styled:'<div class="fm-disclaimerfao-text"></div>',disclaimerfao_fr:"",disclaimerfao_fr_styled:'<div class="fm-disclaimerfao-text"></div>'},FM.WCS=function(){var a={url:{}},b=a.url.MAP_SERVICE_PROXY?a.url.MAP_SERVICE_PROXY:"http://fenixapps2.fao.org/maps/rest/service/request",c="1.1.1",d={"1.1.1":"identifiers","2.0":"identifiers"},e=function(a,e){var g=b;g+="?service=wcs",g+=a.version?"&version="+a.version:"&version="+c,g+="&request=DescribeCoverage",g+="&"+d[c]+"="+a.layername,g+="&urlWMS="+a.url,$.ajax({type:"GET",url:g,success:function(a){f(a,e)},error:function(){console.log("WCS error getDescription() REQUEST")}})},f=function(a,b){var c="TODO: parse XML if there are useful information";b&&b(c)};return{getDescription:e,getVersion:function(){return c}}}(),FM.WFS=function(a){var a={url:{}},b=a.url.BASEURL_MAPS?a.url.MAP_SERVICE_PROXY:"http://fenixapps2.fao.org/maps/rest/service/request",c="1.1.0",d={"1.1.0":"typeName","2.0":"typeNames"},e=function(a,e){var g=b;g+="?SERVICE=WFS",g+=a.version?"&VERSION="+a.version:"&VERSION="+c,g+="&request=DescribeFeatureType",g+="&"+d[c]+"="+a.layername,g+="&urlWMS="+a.url,$.ajax({type:"GET",url:g,success:function(a){f(a,e)},error:function(){console.log("WFS error getDescription() REQUEST")}})},f=function(a,b){var c=$.parseXML(a),d=$(c),e=[];d.find("xsd\\:sequence xsd\\:element").each(function(){e.push({name:$(this).attr("name"),type:$(this).attr("type")})}),b&&b(e)},g=function(a,e){var f=b;f+="?SERVICE=WFS",f+=a.version?"&VERSION="+a.version:"&VERSION="+c,f+="&request=GetFeature",f+="&"+d[c]+"="+a.layername,f+=a.propertyname?"&propertyname="+a.propertyname:"",f+=a.sortby?"&sortby="+a.sortby:"",f+="&outputFormat=json",f+="&urlWMS="+a.url,$.ajax({type:"GET",url:f,success:function(a){e&&e(a)},error:function(){console.log("WFS error getDescription() REQUEST")}})};return{getFields:e,getFieldsValues:g,getVersion:function(){return c}}}(),FM.LayerSwipe={swipeActivate:function(a,b,c,d){function e(a){a=Math.max(0,Math.min(a,d.getSize().x)),g.style.left=a+"px";var b=d.containerPointToLayerPoint(a,0).x;f.style.clip="rect(-99999px "+b+"px 999999px -99999px)"}a.layer.swipeActive=!0;var f=a.leafletLayer._container,g=document.getElementById(b),h=!1;g.onmousedown=function(){return h=!0,!1},document.onmouseup=function(){h=!1},document.onmousemove=function(a){h&&e(a.x)};a.redraw=function(b){f=a.leafletLayer._container,e(parseInt(g.style.left))},a.mousemoveSwipe=function(b){f=a.leafletLayer._container,e(b.containerPoint.x)},d.on("zoomend",a.redraw),d.on("moveend",a.redraw),d.on("drag",a.redraw),d.on("mousemove",a.mousemoveSwipe);var i=$("#"+c).width();e(i/2)},swipeDeactivate:function(a,b){b.off("zoomend",a.redraw),b.off("moveend",a.redraw),b.off("drag",a.redraw),b.off("mousemove",a.mousemoveSwipe),a.layer.swipeActive=!1;var c=a.leafletLayer._container;c.style.clip="auto"}},FM.LayerUtils={setLayerOpacity:function(a,b){a.leafletLayer&&a.leafletLayer.setOpacity(b),a.layer.opacity=b},filterLayerMinEqualThan:function(a,b,c){b=FM.LayerUtils.getValuesMinEqualThan(b,c),b.redraw()},filterLayerGreaterEqualThan:function(a,b,c){b=FM.LayerUtils.getValuesGreaterEqualThan(b,c),b.redraw()},filterLayerInBetweenEqualThan:function(a,b,c,d){b=FM.LayerUtils.getValuesInBetweenEqualThan(b,c,d),b.redraw()},filterLayerOuterEqualThan:function(a,b,c,d){b=FM.LayerUtils.getValuesOuterEqualThan(b,c,d),b.redraw()},getValuesMinEqualThan:function(a,b){for("string"==typeof a.layer.defaultdata&&(a.layer.defaultdata=$.parseJSON(a.layer.defaultdata)),a.layer.joindata=[],i=0;i<a.layer.defaultdata.length;i++)$.each(a.layer.defaultdata[i],function(c,d){b>=d&&a.layer.joindata.push(a.layer.defaultdata[i])});return a.layer.joindata=JSON.stringify(a.layer.joindata),a},getValuesGreaterEqualThan:function(a,b){for("string"==typeof a.layer.defaultdata&&(a.layer.defaultdata=$.parseJSON(a.layer.defaultdata)),a.layer.joindata=[],i=0;i<a.layer.defaultdata.length;i++)$.each(a.layer.defaultdata[i],function(c,d){d>=b&&a.layer.joindata.push(a.layer.defaultdata[i])});return a.layer.joindata=JSON.stringify(a.layer.joindata),a},getValuesInBetweenEqualThan:function(a,b,c){for("string"==typeof a.layer.defaultdata&&(a.layer.defaultdata=$.parseJSON(a.layer.defaultdata)),a.layer.joindata=[],i=0;i<a.layer.defaultdata.length;i++)$.each(a.layer.defaultdata[i],function(d,e){e>=b&&c>=e&&a.layer.joindata.push(a.layer.defaultdata[i])});return a.layer.joindata=JSON.stringify(a.layer.joindata),a},getValuesOuterEqualThan:function(a,b,c){for("string"==typeof a.layer.defaultdata&&(a.layer.defaultdata=$.parseJSON(a.layer.defaultdata)),a.layer.joindata=[],i=0;i<a.layer.defaultdata.length;i++)$.each(a.layer.defaultdata[i],function(d,e){(b&&b>=e||c&&e>=c)&&a.layer.joindata.push(a.layer.defaultdata[i])});return a.layer.joindata=JSON.stringify(a.layer.joindata),a}},FM.MapUtils=function(){var a=function(a,b){var c=a.map?a.map:a,d=b.map?b.map:b;c.on("dragend zoomend",function(a){c.getCenter()!=d.getCenter&&c.getZoom()!=d.getZoom&&d.setView(c.getCenter(),c.getZoom())})},b=function(a){},c=function(a,b,c,d){var e=a.options.url.ZOOM_TO_BBOX+b+"/"+c+"/"+d.toString();$.ajax({type:"GET",url:e,success:function(b){a.hasOwnProperty("map")?a.map.fitBounds(b):a.fitBounds(b)}})},d=function(a,b,d){c(a,"country",b,d)},e=function(a,b,c){var d="";return $.ajax({url:c,data:{stylename:a,style:b},async:!1,type:"POST",success:function(a){d=a}}),d},f=function(a,b){var c=L.latLngBounds([[-90,-180],[90,180]]),d=b instanceof L.LatLngBounds?b:c,e=190,f=190,g=d.getSouthWest().lng,h=d.getNorthEast().lng,i=h-g,j=d.getNorthEast().lat,k=d.getSouthWest().lat,l=j-k,m=a.getSize().x,n=a.getSize().y;0>i&&(i+=360),0>l&&(l+=360);var o=Math.round(Math.log(360*m/i/e)/Math.LN2),p=Math.round(Math.log(360*n/l/f)/Math.LN2),q=Math.max(o,p)-1;a.setZoom(q,{animate:!1})};return{syncMapsOnMove:a,exportLayers:b,zoomTo:c,zoomToCountry:d,getSLDfromCSS:e,fitWorldByScreen:f}}(),FM.Plugins={_addzoomcontrol:function(a,b){if(b){var c="string"==typeof a.options.plugins.zoomcontrol?a.options.plugins.zoomcontrol:"bottomright";return new L.Control.Zoom({position:c}).addTo(a.map)}},_addfullscreen:function(a,b){return b&&window.fullScreenApi&&window.fullScreenApi.supportsFullScreen?function(){var b="string"==typeof a.options.plugins.zoomcontrol?a.options.plugins.zoomcontrol:"bottomright",c="string"==typeof a.options.plugins.fullscreen?a.options.plugins.fullscreen:b,d=new L.Control({position:c});return d.onAdd=function(b){var c=L.DomUtil.create("div","leaflet-control-fullscreen fm-icon-box-background"),d=L.DomUtil.create("a","fm-icon-sprite fm-btn-icon",c);return L.DomEvent.disableClickPropagation(d).addListener(d,"click",function(){var b=a.options.plugins.fullscreen.id||a.id,c=document.getElementById(b);window.fullScreenApi.isFullScreen(c)?window.fullScreenApi.cancelFullScreen(c):window.fullScreenApi.requestFullScreen(c)},d),c},d}().addTo(a.map):void 0},_addzoomresetcontrol:function(a,b){return b?function(){var b="string"==typeof a.options.plugins.zoomcontrol?a.options.plugins.zoomcontrol:"bottomright",c="string"==typeof a.options.plugins.zoomresetcontrol?a.options.plugins.zoomresetcontrol:b,d=new L.Control({position:c}),e=a.plugins.zoomcontrol._container;return d.onAdd=function(a){var b=L.DomUtil.create("div","leaflet-control-zoom-reset",e);b.innerHTML="&nbsp;",b.title="Zoom Reset",L.DomEvent.disableClickPropagation(b).addListener(b,"click",function(){a.setView(a.options.center,a.options.zoom)},b);var c=L.DomUtil.create("span");return c.style.display="none",c},d}().addTo(a.map):void 0},_adddisclaimerfao:function(a,b){return b&&$.powerTip?function(){var b="string"==typeof a.options.plugins.disclaimerfao?a.options.plugins.disclaimerfao:"bottomright",c=new L.Control({position:b}),d=a.options.lang.toLowerCase();return c.onAdd=function(a){var b=L.DomUtil.create("div","leaflet-control-disclaimer fm-icon-box-background"),c=L.DomUtil.create("a","fm-icon-sprite fm-icon-info",b);return c.title=FM.guiMap["disclaimerfao_"+d],$(c).powerTip({placement:"nw"}),b},c}().addTo(a.map):void 0},_addlayercontroller:function(a,b){b?$("#"+this.suffix+"-controller").show():$("#"+this.suffix+"-controller").hide()},_addgeosearch:function(a,b){return b&&L.GeoSearch?new L.Control.GeoSearch({provider:new L.GeoSearch.Provider.OpenStreetMap}).addTo(a.map):void 0},_addgeocoder:function(a,b){return b&&L.Control.OSMGeocoder?(new L.Conpluginstrol.OSMGeocoder).addTo(a.map):void 0},_addmouseposition:function(a,b){b&&L.control.mousePosition&&L.control.mousePosition().addTo(a.map)},_addexport:function(a,b){b&&L.Control.Export&&a.map.addControl(new L.Control.Export)},_addprintmodule:function(a,b){if(b&&L.print)var c=L.print.provider({method:"GET",url:"http://hqlprfenixapp1.hq.un.fao.org:10090/geoserver/pdf",autoLoad:!0,dpi:254});var d=L.control.print({provider:c});a.map.addControl(d)},_adddrawcontrol:function(a,b){if(b&&L.Control.Draw){var c=new L.FeatureGroup;a.map.addLayer(c);var d=new L.Control.Draw({draw:{position:"topleft",polygon:{title:"Draw a polygon!",allowIntersection:!1,drawError:{color:"#b00b00",timeout:1e3},shapeOptions:{color:"#bada55"}},circle:{shapeOptions:{color:"#662d91"}}},edit:{featureGroup:c}});a.map.addControl(d),a.map.on("draw:created",function(b){var d=b.layerType,e=b.layer;"marker"===d&&e.bindPopup("A popup!"),l=e,l.layerType=d,c.addLayer(e),a.spatialQuery(e)}),a.map.on("draw:edited",function(a){var b=a.layers,c=0;b.eachLayer(function(a){c++})})}},_addcontrolloading:function(a,b){if(b&&L.Control.loading){var c=L.Control.loading({separate:!0,position:"topright"});a.map.addControl(c)}},_addscalecontrol:function(a,b){if(b&&L.Control.Scale){var c="string"==typeof a.options.plugins.scalecontrol?a.options.plugins.scalecontrol:"topleft";L.control.scale({position:c}).addTo(a.map)}},_addlegendcontrol:function(a,b){return b?function(){var b="string"==typeof a.options.plugins.legendcontrol?a.options.plugins.legendcontrol:"topright",c=new L.Control({position:b});return c.onAdd=function(a){var b=L.DomUtil.create("div","leaflet-control-legend");return b},c}().addTo(a.map):void 0}},FM.SpatialQuery={getFeatureInfoJoin:function(a,b,c,d){null==a.layer.customgfi&&FMDEFAULTLAYER.joinDefaultPopUp(a.layer),FM.SpatialQuery.getFeatureInfoStandard(a,b,c,d)},getFeatureInfoStandard:function(a,b,c,d){var e=d.map,f=e.getBounds(),g=e.options.crs.project(f.getSouthWest()),h=e.options.crs.project(f.getNorthEast()),i=g.x+","+g.y+","+h.x+","+h.y,j=e.getSize().x,k=e.getSize().y,l=e.layerPointToContainerPoint(b).x,m=e.layerPointToContainerPoint(b).y;l=new Number(l),l=l.toFixed(0),m=new Number(m),m=m.toFixed(0);var n=d.options.url.MAP_SERVICE_GFI_STANDARD;n+="?SERVICE=WMS",n+="&VERSION=1.1.1",n+="&REQUEST=GetFeatureInfo",n+="&BBOX="+i,n+="&HEIGHT="+k,n+="&WIDTH="+j,n+="&X="+l,n+="&Y="+m,n+="&FORMAT=image/png",n+="&INFO_FORMAT=text/html",""!=a&&null!=a&&(n+="&LAYERS="+a.layer.layers,n+="&QUERY_LAYERS="+a.layer.layers,n+="&STYLES=",n+="&SRS=EPSG:3857",n+="&urlWMS="+a.layer.urlWMS,FM.SpatialQuery.getFeatureInfoJoinRequest(n,"GET",c,e,a))},getFeatureInfoJoinRequest:function(a,b,c,d,e){var f=null!=e.layer.lang?e.layer.lang:d.options.lang,g=d,h=e;$.ajax({type:"GET",url:a,success:function(a){if(null!=a){var b=$("#"+g._fenixMap.id).width()-15,d=$("#"+g._fenixMap.id).height()-15,i=new L.Popup({maxWidth:b,maxHeight:d}),j=a;if(h.layer.customgfi){var k=null!=h.layer.joindata?h.layer.joindata:h.layer.data,l=FM.SpatialQuery.customPopup(a,h.layer.customgfi,f,k,e.layer);j=null!=l?l[0]:a}else{var l=FM.SpatialQuery.transposeHTMLTable(a,h.layer.layertitle);j=null!=l?l[0]:a}j=FM.SpatialQuery._checkGeoserverDefaultEmptyOutput(j),h.layer.customgfi?(h.layer.customgfi&&h.layer.customgfi.callback&&h.layer.customgfi.callback(j,h.layer),h.layer.customgfi&&h.layer.customgfi.output&&h.layer.customgfi.output.show&&($("#"+h.layer.customgfi.output.id).empty(),j&&$("#"+h.layer.customgfi.output.id).append(j)),h.layer.customgfi&&h.layer.customgfi.showpopup&&j&&(i.setLatLng(c).setContent(j),g.openPopup(i))):j&&(i.setLatLng(c).setContent(j),g.openPopup(i))}}})},customPopup:function(a,b,c,d,e){var f=this._parseHTML(b.content[c]);if(f.id.length>0||f.joinid.length>0){var g=$("<div></div>").append(a),h=g.find("table");if(h)return FM.SpatialQuery._customizePopUp(b.content[c],f,h,d,e)}},_checkGeoserverDefaultEmptyOutput:function(a){return a},_customizePopUp:function(a,b,c,d,e){for(var f=c.find("tr"),g=$(f[0]).find("th"),h=[],i=[],j=0;j<g.length;j++)for(var k=0;k<b.id.length;k++)if(b.id[k].toUpperCase()==g[j].innerHTML.toUpperCase()){i.push(j);break}if(d)for(var l=[],j=0;j<g.length;j++)for(var k=0;k<b.joinid.length;k++)if(b.joinid[k].toUpperCase()==g[j].innerHTML.toUpperCase()){l.push(j);break}for(var j=1;j<f.length;j++)h.push($(f[j]).find("td"));for(var m=[],k=0;k<h.length;k++){for(var n=a,j=0;j<i.length;j++){var o="{{"+g[i[j]].innerHTML+"}}",p=h[k][i[j]].innerHTML;n=FM.Util.replaceAll(n,o,p)}var q=!1;if(d)for(var j=0;j<l.length;j++){var o="{{{"+g[l[j]].innerHTML+"}}}",p=h[k][l[j]].innerHTML,r=FM.SpatialQuery._getJoinValueFromCode(p,d);r="NA"!==r&&e.decimalvalues?r.toFixed(e.decimalvalues):r,n=FM.Util.replaceAll(n,o,r),"NA"!==r&&(q=!0)}m.push(n)}return m[0]=FM.Util.replaceAll(m[0],"{{measurementunit}}",q?e.measurementunit:""),m},_getJoinValueFromCode:function(a,b){for(var c=parseInt(a)?parseInt(a):null,d="string"==typeof b?$.parseJSON(b):b,e=0;e<d.length;e++)if(d[e][a]||d[e][c])return d[e][a]?d[e][a]:d[e][c];return"NA"},_parseHTML:function(a){var b={};b.id=[],b.joinid=[];for(var c=a.match(/\{\{.*?\}\}/g),d=0;d<c.length;d++)c[d]=FM.Util.replaceAll(c[d],"{{",""),c[d]=FM.Util.replaceAll(c[d],"}}",""),c[d].indexOf("{")>=0?(c[d]=FM.Util.replaceAll(c[d],"{",""),c[d]=FM.Util.replaceAll(c[d],"}",""),b.joinid.push(c[d])):b.id.push(c[d]);return b},transposeHTMLTable:function(a,b){var c=$("<div></div>").append(a),d=c.find("table");if(d){var e=FM.SpatialQuery.transposeHTML(d,b);if(null!=e)return e}return null},transposeHTML:function(a,b){var c=$('<div class="fm-transpose-popup"></div>');a.find("caption");try{c.append(b);for(var d=a.find("tr"),e=$(d[0]).find("th"),f=[],g=1;g<d.length;g++)f.push($(d[g]).find("td"));for(var h=$("<table></table>"),i=$("<tbody></tbody>"),g=0;g<e.length;g++){for(var j="<tr>",k="<td>"+e[g].innerHTML+"</td>",l=0;l<f.length;l++)k+="<td>"+f[l][g].innerHTML+"</td>";j+=k,j+="</tr>",i.append(j)}return c.append(h.append(i))}catch(m){return null}},filterLayerMinEqualThan:function(a,b){FM.LayerUtils.filterLayerMinEqualThan(this,a,b)},filterLayerGreaterEqualThan:function(a,b){
FM.LayerUtils.filterLayerGreaterEqualThan(this,a,b)},filterLayerInBetweenEqualThan:function(a,b,c){FM.LayerUtils.filterLayerInBetweenEqualThan(this,a,b,c)},filterLayerOuterEqualThan:function(a,b,c){FM.LayerUtils.filterLayerOuterEqualThan(this,a,b,c)}},FM.Layer=FM.Class.extend({_fenixmap:"",id:"",layer:{styles:"",srs:"EPSG:3857",visibility:!0,format:"image/png",transparent:"TRUE",opacity:1,name:"",title:"","abstract":"",srs:"",LatLonBoundingBox:"",BoundingBox:"",Style:{name:"",title:"","abstract":"",legendurl:{format:"",onlineresource:""}},KeywordList:[],layertitle:"",enablegfi:!0,layertype:"WMS",openlegend:!1,switchjointype:!1,lang:"EN"},leafletLayer:"",initialize:function(a,b){this.layer=$.extend(!0,{},this.layer,a),b&&(this.options=b),this.layer.zindex&&(this.layer.zIndex=this.layer.zindex),this.id=FM.Util.randomID(),a.joindata&&(a.defaultdata=a.joindata)},createLayerWMS:function(){var a=this._getWMSParameters();return this.leafletLayer?"WMS"===this.layertype&&this.leafletLayer.setParams(a):(a=this.options?$.extend(!0,{},this.options,a):a,this.leafletLayer=new L.TileLayer.WMS(this.layer.urlWMS,a)),this.leafletLayer.setZIndex(this.layer.zIndex),this.leafletLayer},createLayerWMSSLD:function(){var a=this._getWMSParameters();return this.leafletLayer?this.leafletLayer.setParams(a):this.leafletLayer=new L.TileLayer.WMS(this.layer.urlWMS,a),this.leafletLayer.setZIndex(this.layer.zIndex),this.leafletLayer},_getWMSParameters:function(){var a={};return a.id=this.id,a.layers=this.layer.name?this.layer.name:this.layer.layers,a.format=this.layer.format,a.transparent=this.layer.transparent.toUpperCase(),a.visibility=this.layer.visibility,a.opacity=this.layer.opacity,a.styles=this.layer.styles,this.layer.style&&(a.styles=this.layer.style),this.layer.sldurl&&(a.sld=this.layer.sldurl),this.layer.cql_filter&&(a.cql_filter=this.layer.cql_filter),this.layer.sld_body&&(a.sld_body=this.layer.sld_body),this.layer.layers=this.layer.layername?this.layer.layername:this.layer.layers,a},redraw:function(a){var b=this;if(b.layer.layertype)switch(b.layer.layertype){case"JOIN":"SHADED"==b.layer.jointype.toLocaleUpperCase()?a?a.addLayer(this):this._fenixmap&&this._fenixmap.addLayer(this):"POINT"==b.layer.jointype.toLocaleUpperCase()&&console.log("TODO: handle redraw point");break;case"WMS":this.createLayerWMS(),this.leafletLayer.redraw();break;default:this.createLayerWMS(),this.leafletLayer.redraw()}},removeLayer:function(a){a?a.removeLayer(this):this._fenixmap&&this._fenixmap.removeLayer(this)},addPointLayer:function(a){a?a.addPointLayer(this):this._fenixmap&&this._fenixmap.addPointLayer(this)},addLayerWMS:function(a){a?a.addLayerWMS(this):this._fenixmap&&this._fenixmap.addLayerWMS(this)},addLayer:function(a){a?a.addLayer(this):this._fenixmap&&this._fenixmap.addLayer(this)},addShadedLayer:function(a){a?a.addShadedLayer(this):this._fenixmap&&this._fenixmap.addShadedLayer(this)}}),FM.layer=function(a,b,c){return new FM.Layer(a,b,c)},FM.TileLayer=FM.Layer.extend({createTileLayer:function(){var a=this.layer.layername?FM.TILELAYER[this.layer.layername]:FM.TILELAYER[this.layer.layers];this.layer.layertype="TILE",this.layer.layertitle=a["title_"+this.layer.lang.toLowerCase()];var b=new L.TileLayer(a.url);return b}}),FM.TileLayer.createBaseLayer=function(a,b){var c={};c.layername=a,c.layers=a,c.layertype="TILE",c.lang=b;var d=new FM.TileLayer(c);return d.leafletLayer=d.createTileLayer(c.layername),d};